#include <cstdio>
#include <cmath>
#include <cstdlib>

#include "IceException.h"
#include "defs.h"
#include "macro.h"

#include "paint.h"


namespace ice
{

  static const unsigned char textcode[256][8] =
  {
    /*   0 */ {  0,  0,  0,  0,  0,  0,  0,  0},
    /*   1 */ {126, 129, 165, 129, 189, 153, 129, 126},
    /*   2 */ {126, 255, 219, 255, 195, 231, 255, 126},
    /*   3 */ {108, 254, 254, 254, 124, 56, 16,  0},
    /*   4 */ {0x10, 0x38, 0x7c, 0x0fe, 0x7c, 0x38, 0x10, 0 },
    /*   5 */ { 56, 124, 56, 254, 254, 124, 56, 124},
    /*   6 */ { 16, 16, 56, 124, 254, 124, 56, 124},
    /*   7 */ {  0,  0, 24, 60, 60, 24,  0,  0},
    /*   8 */ {255, 255, 231, 195, 195, 231, 255, 255},
    /*   9 */ {  0, 56, 102, 66, 66, 102, 60,  0},
    /*  10 */ {255, 195, 153, 189, 189, 153, 195, 255},
    /*  11 */ { 15,  7, 15, 125, 204, 204, 204, 120},
    /*  12 */ { 60, 102, 102, 102, 60, 24, 126, 24},
    /*  13 */ { 63, 51, 63, 48, 48, 112, 240, 224},
    /*  14 */ {127, 99, 127, 99, 99, 103, 230, 192},
    /*  15 */ {153, 90, 60, 231, 231, 60, 90, 153},
    /*  16 */ {128, 224, 248, 254, 248, 224, 128,  0},
    /*  17 */ {  2, 14, 62, 254, 62, 14,  2,  0},
    /*  18 */ { 24, 60, 126, 24, 24, 126, 60, 24},
    /*  19 */ {102, 102, 102, 102, 102,  0, 102,  0},
    /*  20 */ {123, 219, 219, 123, 27, 27, 27,  0},
    /*  21 */ { 62, 99, 56, 108, 108, 56, 204, 120},
    /*  22 */ {  0,  0,  0,  0, 126, 126, 126,  0},
    /*  23 */ { 24, 60, 126, 24, 126, 60, 24, 255},
    /*  24 */ { 24, 60, 126, 24, 24, 24, 24,  0},
    /*  25 */ { 24, 24, 24, 24, 126, 60, 24,  0},
    /*  26 */ {  0, 24, 12, 254, 12, 24,  0,  0},
    /*  27 */ {  0, 48, 96, 254, 96, 48,  0,  0},
    /*  28 */ {  0,  0, 192, 192, 192, 254,  0,  0},
    /*  29 */ {  0, 36, 102, 255, 102, 36,  0,  0},
    /*  30 */ {  0, 24, 60, 126, 255, 255,  0,  0},
    /*  31 */ {  0, 255, 255, 126, 60, 24,  0,  0},
    /*  32 */ {  0,  0,  0,  0,  0,  0,  0,  0},
    /*  33 */ { 48, 120, 120, 48, 48,  0, 48,  0},
    /*  34 */ {108, 108, 108,  0,  0,  0,  0,  0},
    /*  35 */ {108, 108, 254, 108, 254, 108, 108,  0},
    /*  36 */ { 48, 124, 192, 120, 12, 248, 48,  0},
    /*  37 */ {  0, 198, 204, 24, 48, 102, 198,  0},
    /*  38 */ { 56, 108, 56, 118, 220, 204, 118,  0},
    /*  39 */ { 96, 96, 192,  0,  0,  0,  0,  0},
    /*  40 */ { 24, 48, 96, 96, 96, 48, 24,  0},
    /*  41 */ { 96, 48, 24, 24, 24, 48, 96,  0},
    /*  42 */ {  0, 102, 60, 255, 60, 102,  0,  0},
    /*  43 */ {  0, 48, 48, 252, 48, 48,  0,  0},
    /*  44 */ {  0,  0,  0,  0,  0, 48, 48, 96},
    /*  45 */ {  0,  0,  0, 252,  0,  0,  0,  0},
    /*  46 */ {  0,  0,  0,  0,  0, 48, 48,  0},
    /*  47 */ {  6, 12, 24, 48, 96, 192, 128,  0},
    /*  48 */ {124, 198, 206, 222, 246, 230, 124,  0},
    /*  49 */ { 48, 112, 48, 48, 48, 48, 252,  0},
    /*  50 */ {120, 204, 12, 56, 96, 204, 252,  0},
    /*  51 */ {120, 204, 12, 56, 12, 204, 120,  0},
    /*  52 */ { 28, 60, 108, 204, 254, 12, 30,  0},
    /*  53 */ {252, 192, 248, 12, 12, 204, 120,  0},
    /*  54 */ { 56, 96, 192, 248, 204, 204, 120,  0},
    /*  55 */ {252, 204, 12, 24, 48, 48, 48,  0},
    /*  56 */ {120, 204, 204, 120, 204, 204, 120,  0},
    /*  57 */ {120, 204, 204, 124, 12, 24, 112,  0},
    /*  58 */ {  0, 48, 48,  0,  0, 48, 48,  0},
    /*  59 */ {  0, 48, 48,  0,  0, 48, 48, 96},
    /*  60 */ { 24, 48, 96, 192, 96, 48, 24,  0},
    /*  61 */ {  0,  0, 252,  0,  0, 252,  0,  0},
    /*  62 */ { 96, 48, 24, 12, 24, 48, 96,  0},
    /*  63 */ {120, 204, 12, 24, 48,  0, 48,  0},
    /*  64 */ {120, 198, 222, 222, 222, 192, 120,  0},
    /*  65 */ { 48, 120, 204, 204, 252, 204, 204,  0},
    /*  66 */ {252, 102, 102, 124, 102, 102, 252,  0},
    /*  67 */ { 60, 102, 192, 192, 192, 102, 60,  0},
    /*  68 */ {248, 108, 102, 102, 102, 108, 248,  0},
    /*  69 */ {254, 98, 104, 120, 104, 98, 254,  0},
    /*  70 */ {254, 98, 104, 120, 104, 96, 240,  0},
    /*  71 */ { 60, 102, 192, 192, 206, 102, 62,  0},
    /*  72 */ {204, 204, 204, 252, 204, 204, 204,  0},
    /*  73 */ {120, 48, 48, 48, 48, 48, 120,  0},
    /*  74 */ { 30, 12, 12, 12, 204, 204, 120,  0},
    /*  75 */ {230, 102, 108, 120, 108, 102, 230,  0},
    /*  76 */ {240, 96, 96, 96, 98, 102, 254,  0},
    /*  77 */ {198, 238, 254, 254, 214, 198, 198,  0},
    /*  78 */ { 98, 230, 246, 222, 206, 198, 198,  0},
    /*  79 */ { 56, 108, 198, 198, 198, 108, 56,  0},
    /*  80 */ {252, 102, 102, 124, 96, 96, 240,  0},
    /*  81 */ {120, 204, 204, 204, 220, 120, 28,  0},
    /*  82 */ {252, 102, 102, 124, 108, 102, 230,  0},
    /*  83 */ {120, 204, 224, 112, 28, 204, 120,  0},
    /*  84 */ {252, 180, 48, 48, 48, 48, 120,  0},
    /*  85 */ {204, 204, 204, 204, 204, 204, 252,  0},
    /*  86 */ {204, 204, 204, 204, 204, 120, 48,  0},
    /*  87 */ {198, 198, 198, 214, 254, 238, 198,  0},
    /*  88 */ {198, 198, 108, 56, 56, 108, 198,  0},
    /*  89 */ {204, 204, 204, 120, 48, 48, 120,  0},
    /*  90 */ {254, 198, 140, 24, 50, 102, 254,  0},
    /*  91 */ {120, 96, 96, 96, 96, 96, 120,  0},
    /*  92 */ {192, 96, 48, 24, 12,  6,  2,  0},
    /*  93 */ {120, 24, 24, 24, 24, 24, 120,  0},
    /*  94 */ { 16, 56, 108, 198,  0,  0,  0,  0},
    /*  95 */ {  0,  0,  0,  0,  0,  0,  0, 255},
    /*  96 */ { 48, 48, 24,  0,  0,  0,  0,  0},
    /*  97 */ {  0,  0, 120, 12, 124, 204, 118,  0},
    /*  98 */ {224, 96, 96, 124, 102, 102, 220,  0},
    /*  99 */ {  0,  0, 120, 204, 192, 204, 120,  0},
    /* 100 */ { 28, 12, 12, 124, 204, 204, 118,  0},
    /* 101 */ {  0,  0, 120, 204, 252, 192, 120,  0},
    /* 102 */ { 28, 54, 96, 240, 96, 96, 240,  0},
    /* 103 */ {  0,  0, 118, 204, 204, 124, 12, 248},
    /* 104 */ {224, 96, 108, 118, 102, 102, 230,  0},
    /* 105 */ { 48,  0, 112, 48, 48, 48, 120,  0},
    /* 106 */ { 12,  0, 12, 12, 12, 204, 204, 120},
    /* 107 */ {224, 96, 102, 108, 120, 108, 230,  0},
    /* 108 */ {112, 48, 48, 48, 48, 48, 120,  0},
    /* 109 */ {  0,  0, 204, 254, 254, 214, 198,  0},
    /* 110 */ {  0,  0, 248, 204, 204, 204, 204,  0},
    /* 111 */ {  0,  0, 120, 204, 204, 204, 120,  0},
    /* 112 */ {  0,  0, 220, 102, 102, 124, 96, 240},
    /* 113 */ {  0,  0, 118, 204, 204, 124, 12, 30},
    /* 114 */ {  0,  0, 220, 118, 102, 96, 240,  0},
    /* 115 */ {  0,  0, 124, 192, 120, 12, 248,  0},
    /* 116 */ { 16, 48, 124, 48, 48, 52, 24,  0},
    /* 117 */ {  0,  0, 204, 204, 204, 204, 118,  0},
    /* 118 */ {  0,  0, 204, 204, 204, 120, 48,  0},
    /* 119 */ {  0,  0, 198, 214, 254, 254, 108,  0},
    /* 120 */ {  0,  0, 198, 108, 56, 108, 198,  0},
    /* 121 */ {  0,  0, 204, 204, 204, 124, 12, 248},
    /* 122 */ {  0,  0, 252, 152, 48, 100, 252,  0},
    /* 123 */ { 28, 48, 48, 224, 48, 48, 28,  0},
    /* 124 */ { 24, 24, 24,  0, 24, 24, 24,  0},
    /* 125 */ {224, 48, 48, 28, 48, 48, 224,  0},
    /* 126 */ {118, 220,  0,  0,  0,  0,  0,  0},
    /* 127 */ {  0, 16, 56, 108, 198, 198, 254,  0},
    /* 128 */ {120, 204, 192, 204, 120, 24, 12, 120},
    /* 129 */ {  0, 204,  0, 204, 204, 204, 126,  0},
    /* 130 */ { 28,  0, 120, 204, 252, 192, 120,  0},
    /* 131 */ {126, 195, 60,  6, 62, 102, 63,  0},
    /* 132 */ {204,  0, 120, 12, 124, 204, 126,  0},
    /* 133 */ {224,  0, 120, 12, 124, 204, 126,  0},
    /* 134 */ { 48, 48, 120, 12, 124, 204, 126,  0},
    /* 135 */ {  0,  0, 120, 192, 192, 120, 12, 56},
    /* 136 */ {126, 195, 60, 102, 126, 96, 60,  0},
    /* 137 */ {204,  0, 120, 204, 252, 192, 120,  0},
    /* 138 */ {224,  0, 120, 204, 252, 192, 120,  0},
    /* 139 */ {204,  0, 112, 48, 48, 48, 120,  0},
    /* 140 */ {124, 198, 56, 24, 24, 24, 60,  0},
    /* 141 */ {224,  0, 112, 48, 48, 48, 120,  0},
    /* 142 */ {198, 56, 108, 198, 254, 198, 198,  0},
    /* 143 */ { 48, 48,  0, 120, 204, 252, 204,  0},
    /* 144 */ { 28,  0, 252, 96, 120, 96, 252,  0},
    /* 145 */ {  0,  0, 127, 12, 127, 204, 127,  0},
    /* 146 */ { 62, 108, 204, 254, 204, 204, 206,  0},
    /* 147 */ {120, 204,  0, 120, 204, 204, 120,  0},
    /* 148 */ {  0, 204,  0, 120, 204, 204, 120,  0},
    /* 149 */ {  0, 224,  0, 120, 204, 204, 120,  0},
    /* 150 */ {120, 204,  0, 204, 204, 204, 126,  0},
    /* 151 */ {  0, 224,  0, 204, 204, 204, 126,  0},
    /* 152 */ {  0, 204,  0, 204, 204, 124, 12, 248},
    /* 153 */ {195, 24, 60, 102, 102, 60, 24,  0},
    /* 154 */ {204,  0, 204, 204, 204, 204, 120,  0},
    /* 155 */ { 24, 24, 126, 192, 192, 126, 24, 24},
    /* 156 */ { 56, 108, 100, 240, 96, 230, 252,  0},
    /* 157 */ {204, 204, 120, 252, 48, 252, 48, 48},
    /* 158 */ {248, 204, 204, 250, 198, 207, 198, 199},
    /* 159 */ { 14, 27, 24, 60, 24, 24, 216, 112},
    /* 160 */ { 28,  0, 120, 12, 124, 204, 126,  0},
    /* 161 */ { 56,  0, 112, 48, 48, 48, 120,  0},
    /* 162 */ {  0, 28,  0, 120, 204, 204, 120,  0},
    /* 163 */ {  0, 28,  0, 204, 204, 204, 126,  0},
    /* 164 */ {  0, 248,  0, 248, 204, 204, 204,  0},
    /* 165 */ {252,  0, 204, 236, 252, 220, 204,  0},
    /* 166 */ { 60, 108, 108, 62,  0, 126,  0,  0},
    /* 167 */ { 56, 108, 108, 56,  0, 124,  0,  0},
    /* 168 */ { 48,  0, 48, 96, 192, 204, 120,  0},
    /* 169 */ {  0,  0,  0, 252, 192, 192,  0,  0},
    /* 170 */ {  0,  0,  0, 252, 12, 12,  0,  0},
    /* 171 */ {195, 198, 204, 222, 51, 102, 204, 15},
    /* 172 */ {195, 198, 204, 219, 55, 111, 207,  3},
    /* 173 */ { 24, 24,  0, 24, 24, 24, 24,  0},
    /* 174 */ {  0, 51, 102, 204, 102, 51,  0,  0},
    /* 175 */ {  0, 204, 102, 51, 102, 204,  0,  0},
    /* 176 */ { 34, 136, 34, 136, 34, 136, 34, 136},
    /* 177 */ { 85, 170, 85, 170, 85, 170, 85, 170},
    /* 178 */ {219, 119, 219, 238, 219, 119, 219, 238},
    /* 179 */ { 24, 24, 24, 24, 24, 24, 24, 24},
    /* 180 */ { 24, 24, 24, 24, 248, 24, 24, 24},
    /* 181 */ { 24, 24, 248, 24, 248, 24, 24, 24},
    /* 182 */ { 54, 54, 54, 54, 246, 54, 54, 54},
    /* 183 */ {  0,  0,  0,  0, 254, 54, 54, 54},
    /* 184 */ {  0,  0, 248, 24, 248, 24, 24, 24},
    /* 185 */ { 54, 54, 246,  6, 246, 54, 54, 54},
    /* 186 */ { 54, 54, 54, 54, 54, 54, 54, 54},
    /* 187 */ {  0,  0, 254,  6, 246, 54, 54, 54},
    /* 188 */ { 54, 54, 246,  6, 254,  0,  0,  0},
    /* 189 */ { 54, 54, 54, 54, 254,  0,  0,  0},
    /* 190 */ { 24, 24, 248, 24, 248,  0,  0,  0},
    /* 191 */ {  0,  0,  0,  0, 248, 24, 24, 24},
    /* 192 */ { 24, 24, 24, 24, 31,  0,  0,  0},
    /* 193 */ { 24, 24, 24, 24, 255,  0,  0,  0},
    /* 194 */ {  0,  0,  0,  0, 255, 24, 24, 24},
    /* 195 */ { 24, 24, 24, 24, 31, 24, 24, 24},
    /* 196 */ {  0,  0,  0,  0, 255,  0,  0,  0},
    /* 197 */ { 24, 24, 24, 24, 255, 24, 24, 24},
    /* 198 */ { 24, 24, 31, 24, 31, 24, 24, 24},
    /* 199 */ { 54, 54, 54, 54, 55, 54, 54, 54},
    /* 200 */ { 54, 54, 55, 48, 63,  0,  0,  0},
    /* 201 */ {  0,  0, 63, 48, 55, 54, 54, 54},
    /* 202 */ { 54, 54, 247,  0, 255,  0,  0,  0},
    /* 203 */ {  0,  0, 255,  0, 247, 54, 54, 54},
    /* 204 */ { 54, 54, 55, 48, 55, 54, 54, 54},
    /* 205 */ {  0,  0, 255,  0, 255,  0,  0,  0},
    /* 206 */ { 54, 54, 247,  0, 247, 54, 54, 54},
    /* 207 */ { 24, 24, 255,  0, 255,  0,  0,  0},
    /* 208 */ { 54, 54, 54, 54, 255,  0,  0,  0},
    /* 209 */ {  0,  0, 255,  0, 255, 24, 24, 24},
    /* 210 */ {  0,  0,  0,  0, 255, 54, 54, 54},
    /* 211 */ { 54, 54, 54, 54, 63,  0,  0,  0},
    /* 212 */ { 24, 24, 31, 24, 31,  0,  0,  0},
    /* 213 */ {  0,  0, 31, 24, 31, 24, 24, 24},
    /* 214 */ {  0,  0,  0,  0, 63, 54, 54, 54},
    /* 215 */ { 54, 54, 54, 54, 255, 54, 54, 54},
    /* 216 */ { 24, 24, 255, 24, 255, 24, 24, 24},
    /* 217 */ { 24, 24, 24, 24, 248,  0,  0,  0},
    /* 218 */ {  0,  0,  0,  0, 31, 24, 24, 24},
    /* 219 */ {255, 255, 255, 255, 255, 255, 255, 255},
    /* 220 */ {  0,  0,  0,  0, 255, 255, 255, 255},
    /* 221 */ {240, 240, 240, 240, 240, 240, 240, 240},
    /* 222 */ { 15, 15, 15, 15, 15, 15, 15, 15},
    /* 223 */ {255, 255, 255, 255,  0,  0,  0,  0},
    /* 224 */ {  0,  0, 118, 220, 200, 220, 118,  0},
    /* 225 */ {  0, 120, 204, 248, 204, 248, 192, 192},
    /* 226 */ {  0, 252, 204, 192, 192, 192, 192,  0},
    /* 227 */ {  0, 254, 108, 108, 108, 108, 108,  0},
    /* 228 */ {252, 204, 96, 48, 96, 204, 252,  0},
    /* 229 */ {  0,  0, 126, 216, 216, 216, 112,  0},
    /* 230 */ {  0, 102, 102, 102, 102, 124, 96, 192},
    /* 231 */ {  0, 118, 220, 24, 24, 24, 24,  0},
    /* 232 */ {252, 48, 120, 204, 204, 120, 48, 252},
    /* 233 */ { 56, 108, 198, 254, 198, 108, 56,  0},
    /* 234 */ { 56, 108, 198, 198, 108, 108, 238,  0},
    /* 235 */ { 28, 48, 24, 124, 204, 204, 120,  0},
    /* 236 */ {  0,  0, 126, 219, 219, 126,  0,  0},
    /* 237 */ {  6, 12, 126, 219, 219, 126, 96, 192},
    /* 238 */ { 56, 96, 192, 248, 192, 96, 56,  0},
    /* 239 */ {120, 204, 204, 204, 204, 204, 204,  0},
    /* 240 */ {  0, 252,  0, 252,  0, 252,  0,  0},
    /* 241 */ { 48, 48, 252, 48, 48,  0, 252,  0},
    /* 242 */ { 96, 48, 24, 48, 96,  0, 252,  0},
    /* 243 */ { 24, 48, 96, 48, 24,  0, 252,  0},
    /* 244 */ { 14, 27, 27, 24, 24, 24, 24, 24},
    /* 245 */ { 24, 24, 24, 24, 24, 216, 216, 112},
    /* 246 */ { 48, 48,  0, 252,  0, 48, 48,  0},
    /* 247 */ {  0, 118, 220,  0, 118, 220,  0,  0},
    /* 248 */ { 56, 108, 108, 56,  0,  0,  0,  0},
    /* 249 */ {  0,  0,  0, 24, 24,  0,  0,  0},
    /* 250 */ {  0,  0,  0,  0, 24,  0,  0,  0},
    /* 251 */ { 15, 12, 12, 12, 236, 108, 60, 28},
    /* 252 */ {120, 108, 108, 108, 108,  0,  0,  0},
    /* 253 */ {112, 24, 48, 96, 120,  0,  0,  0},
    /* 254 */ {  0,  0, 60, 60, 60, 60,  0,  0},
    /* 255 */ {  0,  0,  0,  0,  0,  0,  0,  0},
  };

  /*
     In das Bild "img" wird der mit dem Textpointer "text_ptr" adressierte
     Text geschrieben. Die Koordinaten "x0" bzw. "y0" geben den linken oberen
     Bezugspunkt an.
  */

  void drawDot(int x, int y, int size, int val, const Image& img)
  {
    for (int yi = y; yi < y + size; yi++)
      if (yi > 0 && yi < img->ysize)
        for (int xi = x; xi < x + size; xi++)
          {
            if (xi > 0 && xi < img->xsize)
              {
                PutVal(img, xi, yi, val);
              }
          }
  }

  void drawChar(unsigned char c, int x, int y, int size, int val, const Image& img)
  {
    for (int j = 0; j < 8; j++)
      {
        /* zeichenzeile */
        int mask = 0x80;
        int DotX = x;

        for (int k = 0; k < 8; k++)
          {
            if (textcode[c][j] & mask)
              {
                drawDot(DotX, y + j * size, size, val, img);
              }

            DotX += size;
            mask = mask >> 1;
          }
      }
  }

#define FNAME "Text"
  int Text(const char* text_ptr,
           int x0, int y0,
           int val,
           int size_exp,
           const Image& img)
  {
    return Text(std::string(text_ptr), x0, y0, val, size_exp, img);
  }

  int Text(const std::string& s,
           IPoint p, int val, int size_exp,
           const Image& img)
  {
    return Text(s, p.x, p.y, val, size_exp, img);
  }

  int Text(const std::string& s,
           int x0, int y0, int val, int size_exp,
           const Image& img)
  {

    int hfeld[5] = {1, 2, 4, 8, 16};

    if ((val < 0) || (val > img->maxval))
      {
        throw IceException(FNAME, M_WRONG_VAL, WRONG_PARAM);
      }

    int DotSize;

    if (size_exp > 5)
      {
        throw IceException(FNAME, M_WRONG_MAGNITUDE, WRONG_PARAM);
      }
    else
      {
        if (size_exp >= 0)
          {
            DotSize = hfeld[size_exp];
          }
        else
          {
            DotSize = -size_exp;
          }
      }

    int SignSize = 8 * DotSize;

    int SignX0 = x0;
    int SignY0 = y0;

    for (unsigned int idx = 0; idx < s.length(); idx++)
      {
        /* zeichen */
        unsigned char c = s[idx];
        drawChar(c, SignX0, SignY0, DotSize, val, img);

        SignX0 += SignSize;

        if (SignX0 + SignSize >= img->xsize)
          {
            // next line
            SignX0 = x0;
            SignY0 += SignSize;
          }

        if (SignY0 + SignSize >= img->ysize)
          {
            return OK;
          }
      }

    return OK;
  }
}
